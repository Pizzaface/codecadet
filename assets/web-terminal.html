<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', 'DejaVu Sans Mono', monospace;
        }
        #terminal {
            width: 100%;
            height: 100vh;
            background-color: #000;
        }
    </style>
</head>
<body>
    <div id="terminal"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <script>
        // Create terminal instance with proper CR/LF handling
        var terminal = new Terminal({
            theme: {
                background: '#000000',
                foreground: '#ffffff',
                cursor: '#ffffff',
                cursorAccent: '#000000',
                selection: '#333333',
                black: '#000000',
                red: '#cd3131',
                green: '#0dbc79',
                yellow: '#e5e510',
                blue: '#2472c8',
                magenta: '#bc3fbc',
                cyan: '#11a8cd',
                white: '#e5e5e5',
                brightBlack: '#666666',
                brightRed: '#f14c4c',
                brightGreen: '#23d18b',
                brightYellow: '#f5f543',
                brightBlue: '#3b8eea',
                brightMagenta: '#d670d6',
                brightCyan: '#29b8db',
                brightWhite: '#ffffff'
            },
            fontSize: 12,
            fontFamily: '"SF Mono", "Monaco", "Menlo", "Consolas", "DejaVu Sans Mono", monospace',
            cursorBlink: true,
            cursorStyle: 'block',
            scrollback: 10000,
            tabStopWidth: 4,
            cols: 120,
            rows: 30,
            allowTransparency: false,
            // Settings for proper animation handling
            windowsMode: false,
            macOptionIsMeta: true,
            rightClickSelectsWord: true,
            convertEol: false,  // Disable to fix animation newline issues
            scrollOnUserInput: false,  // Don't auto-scroll
            disableStdin: false
        });

        // Add addons
        var fitAddon = new FitAddon.FitAddon();
        var webLinksAddon = new WebLinksAddon.WebLinksAddon();

        terminal.loadAddon(fitAddon);
        terminal.loadAddon(webLinksAddon);

        // Open terminal
        terminal.open(document.getElementById('terminal'));
        fitAddon.fit();

        // Set up Qt WebChannel communication
        var qtBridge = null;
        new QWebChannel(qt.webChannelTransport, function (channel) {
            qtBridge = channel.objects.qtBridge;
            console.log('Qt WebChannel connected');
        });

        // Handle input from terminal
        terminal.onData(function(data) {
            if (qtBridge) {
                qtBridge.write_to_pty(data);
            } else {
                console.log('Qt bridge not ready, data:', data);
            }
        });

        // Debounce helper for resize events
        var resizeTimer = null;
        var lastCols = null;
        var lastRows = null;
        var isResizing = false;

        function handleResize(force) {
            if (typeof force === 'undefined') force = false;
            if (isResizing && !force) {
                console.log('[DEBUG] Resize blocked - already resizing');
                return;
            }

            isResizing = true;
            console.log('[DEBUG] Starting resize, force:', force);
            fitAddon.fit();
            const dims = fitAddon.proposeDimensions();

            if (dims && qtBridge) {
                // Only resize PTY if dimensions actually changed
                if (dims.cols !== lastCols || dims.rows !== lastRows) {
                    console.log('[DEBUG] PTY resize:', lastCols + 'x' + lastRows + ' -> ' + dims.cols + 'x' + dims.rows);
                    lastCols = dims.cols;
                    lastRows = dims.rows;
                    qtBridge.resize_pty(dims.cols, dims.rows);
                } else {
                    console.log('[DEBUG] No PTY resize needed, dimensions unchanged');
                }
            }

            setTimeout(function() {
                isResizing = false;
                console.log('[DEBUG] Resize lock released');
            }, 100);
        }

        // Handle window resize with debouncing
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() { handleResize(true); }, 250);
        });

        // Initial fit when bridge is ready
        setTimeout(function() {
            handleResize();
        }, 500);

        // Throttling for animation updates
        var writeBuffer = '';
        var writeTimer = null;
        var isWriting = false;
        
        function flushWriteBuffer() {
            if (writeBuffer && !isWriting) {
                isWriting = true;
                terminal.write(writeBuffer);
                writeBuffer = '';
                setTimeout(function() {
                    isWriting = false;
                }, 16); // ~60fps limit
            }
        }

        // Global function to write data to terminal
        window.writeToTerminal = function(data) {
            // Debug logging for animation issues
            if (data.includes('\r') || data.includes('\n')) {
                console.log('[DEBUG] Terminal write with CR/LF:', JSON.stringify(data));
                if (data.length > 1 && data.includes('\r') && data.includes('\n')) {
                    console.log('[DEBUG] Mixed CR/LF in JS, length:', data.length);
                }
            }

            // Buffer rapid animation updates to reduce rendering frequency
            writeBuffer += data;
            
            clearTimeout(writeTimer);
            writeTimer = setTimeout(flushWriteBuffer, 8); // Small delay for batching
        };

        // Focus terminal
        terminal.focus();

        console.log('Terminal initialized');
    </script>
</body>
</html>